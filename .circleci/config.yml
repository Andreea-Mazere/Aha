version: 2
jobs:
  build:
    working_directory: ~/Aha
    docker:
      - image: circleci/node:9.7.1-browsers
    steps:
      - checkout
      # Log the current branch
      - run:
          name: Show current branch
          command: echo ${CIRCLE_BRANCH}
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      - run:
          name: install-dependencies
          command: |
            npm install
            npm install -g @angular/cli
      # Cache local dependencies if they don't exist
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
              - node_modules
      - run:
          name: angular-build
          command: ng build --prod
      - run:
          name: angular-test
          command: ng test --watch=false --build=false
      # Cache the dist folder for the deploy job
      - save_cache:
          key: dist-{{ .Environment.CIRCLE_BRANCH }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
              - dist
# The deploy job
  deploy:
    working_directory: ~/Aha
    docker:
      - image: circleci/node:9.7.1-browsers
    steps:
        # Log the current branch
        - run:
            name: Show current branch
            command: echo ${CIRCLE_BRANCH}
        - run:
            name: Install firebase CLI
            command: npm install -g firebase-tools
        # Restore cache from the build job which contains the
        # dist folder that needs to be deployed
        - restore_cache:
            key: dist-{{ .Environment.CIRCLE_BRANCH }}-{{ .Environment.CIRCLE_SHA1 }}    
        - run:
            name: deploy to correct branch
            command: |
              if [ "${CIRCLE_BRANCH}" == "dev" ]; then
                  firebase use default
              elif [ "${CIRCLE_BRANCH}" == "test" ]; then
                  firebase use test
              elif [ "${CIRCLE_BRANCH}" == "master" ]; then
                  firebase use production
              fi
              firebase deploy --token=$FIREBASE_TOKEN --non-interactive

workflows:
    version: 2
    # The build and deploy workflow
    build_and_deploy:
        jobs:
            - build
            # The deploy job will only run on the filtered branches and
            # require the build job to be successful before it starts
            - deploy:
                requires:
                    - build
                filters:
                    branches:
                        only:
                            - dev
                            - test
                            - master